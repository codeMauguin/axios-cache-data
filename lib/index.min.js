import e from"axios";function t(e,t,i,r){return r.get(e,t.expire??i.maxAge)}class i{serializationKey(e){return e}}class r{deserializationKey(e){return e}}class a extends i{serialization(e){return JSON.stringify(e)}}class s extends r{deserialization(e){return JSON.parse(e)}}class n{storage;prefix;message;constructor(e,t,i){this.storage=e,this.message=t,this.prefix=i}}class l extends n{constructor(e,t,i){super(e,t,i)}static isExpired(e,t){return(new Date).getTime()>=t+e}get(e,t){const i=this.message.serialization.serializationKey(`${this.prefix}:${e}`),r=this.storage.getItem(i);if(null==r)return null;const a=this.message.deserialization.deserialization(r);return l.isExpired(a.expire,t)?(this.storage.removeItem(i),null):a.value??null}set(e,t){this.storage.setItem(this.message.serialization.serializationKey(`${this.prefix}:${e}`),this.message.serialization.serialization({value:t,expire:(new Date).getTime()}))}clear(e){if(e)this.storage.removeItem(this.message.serialization.serializationKey(`${this.prefix}:${e}`));else for(let e=0;e<this.storage.length;++e){const t=this.storage.key(e);if(null===t)continue;this.message.deserialization.deserializationKey(t).startsWith(this.prefix)&&this.storage.removeItem(t)}}}function o(e,t,i,r,a,s){return btoa(encodeURIComponent(`${e}&${t}${i}&${JSON.stringify(r)}&${JSON.stringify(a)}-${JSON.stringify(s)}`))}function c(e,t,i,r){return(i.valid&&i.valid(e)||r.valid(e))&&r.cache.set(t,e),e}function u(e,i,r,a,s,n,l,o){if(!1===a.hit||("function"==typeof e.enableCache?!e.enableCache(i,r):!e.enableCache)&&!a.hit)return Reflect.apply(s,n,l);if(a.force)return Promise.resolve(Reflect.apply(s,n,l)).then((t=>c(t,o,a,e)));const u=t(o,a,e,e.cache);return null===u?Promise.resolve(Reflect.apply(s,n,l)).then((t=>c(t,o,a,e))):("production"!==process.env.NODE_ENV&&console.info(`${o}命中缓存`),Promise.resolve(u))}function h(t,i={}){return g(e.create(t),i)}function g(e,t={}){const i={},r=function(e){const{maxAge:t=36e5,key:i="HTTP_CACHE_CACHE",storage:r=window.sessionStorage,prefix:n="AXIOS-CACHE",enableCache:c=!1,generateKey:u=o,valid:h=(()=>!0),message:g={deserialization:new s,serialization:new a}}=e;return{maxAge:t,key:i,storage:r,enableCache:c,generateKey:u,valid:h,message:g,cache:new l(r,g,n)}}(t);return i.clear=()=>r.cache.clear(),new Proxy(e,{get:(e,t,a)=>i[t]?i[t]:i[t]=function(e,t,i,r){return new Proxy(Reflect.get(e,t,i),{apply(e,i,a){let s,n,l,o=t;switch(o.toLowerCase()){case"delete":case"head":case"options":case"get":s={hit:a[1]?.hit,force:a[1]?.force,expire:a[1]?.expire,valid:a[1]?.valid},l=a[0],n=r.generateKey(r.key,a[0],t,a[1]?.header,a[1]?.params??null,a[1]?.data??null);break;case"geturi":case"request":s={hit:a[0]?.hit,force:a[0]?.force,expire:a[0]?.expire,valid:a[0]?.valid},l=a[0].url,o=a[1].method??"get",n=r.generateKey(r.key,a[0]?.url,t,a[0]?.header,a[0]?.params??null,a[0]?.data??null);break;default:s={hit:a[2]?.hit,force:a[2]?.force,expire:a[2]?.expire,valid:a[2]?.valid},l=a[0],n=r.generateKey(r.key,a[0],t,a[2]?.header??null,a[2]?.params??null,a[1]??null)}return u(r,l,o,s,e,i,a,n)}})}(e,t,a,r),apply(e,i,a){let s,n,l,o;return"string"==typeof a[0]?(s=a[0],n=a[1]?.method??"get",l={hit:a[1]?.hit,force:a[1]?.force,expire:a[1]?.expire,valid:a[1]?.valid},o=r.generateKey(t.key,a[0],n,a[1]?.header??null,a[1]?.params??null,a[1]?.data??null)):(s=a[0]?.url,n=a[0]?.method??"get",l={hit:a[0]?.hit,force:a[0]?.force,expire:a[0]?.expire,valid:a[0]?.valid},o=r.generateKey(t.key,a[0]?.url,n,a[0]?.header??null,a[0]?.params??null,a[0]?.data??null)),u(r,s,n,l,e,i,a,o)}})}h.proxy=g,e.withCache=h,e.clear=function(){throw new Error("方法没有实现")};export{t as CacheAdapter,r as Deserialization,s as DeserializationMessageImpl,l as HttpCache,n as HttpCacheLike,i as Serialization,a as SerializationMessageImpl,h as http,g as proxy};
