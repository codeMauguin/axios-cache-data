import e from"axios";class t extends class{storage;prefix;message;constructor(e,t,r){this.storage=e,this.message=t,this.prefix=r}}{constructor(e,t,r){super(e,t,r)}static isExpired(e,t){return(new Date).getTime()>=t+e}get(e,r){const s=this.message.serialization.serializationKey(`${this.prefix}:${e}`),i=this.storage.getItem(s);if(null==i)return null;const a=this.message.deserialization.deserialization(i);return t.isExpired(a.expire,r)?(this.storage.removeItem(s),null):a.value??null}set(e,t){this.storage.setItem(this.message.serialization.serializationKey(`${this.prefix}:${e}`),this.message.serialization.serialization({value:t,expire:(new Date).getTime()}))}clear(e){if(e)this.storage.removeItem(this.message.serialization.serializationKey(`${this.prefix}:${e}`));else for(let e=0;e<this.storage.length;++e){const t=this.storage.key(e);if(null===t)continue;this.message.deserialization.deserializationKey(t).startsWith(this.prefix)&&this.storage.removeItem(t)}}}class r extends class{serializationKey(e){return e}}{serialization(e){return JSON.stringify(e)}}class s extends class{deserializationKey(e){return e}}{deserialization(e){return JSON.parse(e)}}const i=["get","post"];function a(e,t,r,s,i,a){return btoa(encodeURIComponent(`${e}&${t}${r}&${JSON.stringify(s)}&${JSON.stringify(i)}-${JSON.stringify(a)}`))}function n(e){const{maxAge:t=36e5,key:n="HTTP_CACHE_CACHE",storage:o=window.sessionStorage,prefix:l="AXIOS-CACHE",enableCache:u=!1,generateKey:c=a,valid:h=(()=>!0),message:p={deserialization:new s,serialization:new r},proxy:f=i}=e;return{maxAge:t,key:n,storage:o,enableCache:u,generateKey:c,valid:h,message:p,proxy:f,prefix:l}}function o(e,...t){if(null==e)return null;if("function"==typeof e)try{return Reflect.apply(e,this,t)}catch(e){return null}return e}function l(e,t,r,s){return(r.valid&&r.valid(e)||s.valid(e))&&s.cache.set(t,e),e}function u(e,t,r,s,i,a,n,u){const{hit:c,force:h}=s;if(!1===c||!o(e.enableCache,t,r)&&!0!==c)return Reflect.apply(i,a,n);if(!0===h)return Promise.resolve(Reflect.apply(i,a,n)).then((t=>l(t,u,s,e)));const p=e.cache.get(u,s.expire??e.maxAge);return null===p?Promise.resolve(Reflect.apply(i,a,n)).then((t=>l(t,u,s,e))):("production"!==process.env.NODE_ENV&&console.info(`${u}命中缓存`),Promise.resolve(p))}const c=function(e,t){return{apply(r,s,i){const a={hit:i[2]?.hit,force:i[2]?.force,expire:i[2]?.expire,valid:i[2]?.valid},n=i[0],o=t.generateKey(t.key,i[0],e,i[2]?.header??null,i[2]?.params??null,i[1]??null);return u(t,n,e,a,r,s,i,o)}}},h=function(e,t){return{apply(r,s,i){const a={hit:i[1]?.hit,force:i[1]?.force,expire:i[1]?.expire,valid:i[1]?.valid},n=i[0],o=t.generateKey(t.key,i[0],e,i[1]?.header,i[1]?.params??null,i[1]?.data??null);return u(t,n,e,a,r,s,i,o)}}},p=function(e,t){return{apply(r,s,i){const a={hit:i[0]?.hit,force:i[0]?.force,expire:i[0]?.expire,valid:i[0]?.valid},n=i[0].url,o=i[1].method??"get",l=t.generateKey(t.key,i[0]?.url,e,i[0]?.header,i[0]?.params??null,i[0]?.data??null);return u(t,n,o,a,r,s,i,l)}}};function f(t,r={}){return d(e.create(t),r)}function d(e,r={}){let s=Object.assign(n(r));s=Object.assign(s,{cache:new t(s.storage,s.message,s.prefix)});const i=function(e,t,r){const s={};for(let i=0;i<t.length;++i){const a=Reflect.get(e,t[i],e);if(!a)continue;const n=t[i];switch(n){case"delete":case"head":case"options":case"get":s[n]=new Proxy(a,h(n,r));break;case"request":s[n]=new Proxy(a,p(n,r));break;case"post":case"put":case"patch":s[n]=new Proxy(a,c(n,r))}}return s}(e,s.proxy,s);i.clear=()=>s.cache.clear();const a={};return s.proxy.forEach((e=>a[e]=!0)),new Proxy(e,{get:(e,t,r)=>i[t]?i[t]:Reflect.get(e,t,r),apply(e,t,r){if(!r||0===r.length)return Reflect.apply(e,t,r);const i="string"==typeof r[0],n=(i?r[1]?.method:r[0]?.method)??"get";if(a[n]){const a=i?h(n,s):p(n,s);return a.apply&&a.apply(e,t,r)}return Reflect.apply(e,t,r)}})}function g(e){return"object"==typeof e&&"function"==typeof e.then&&"function"==typeof e.catch}f.proxy=d,e.withCache=f,e.clear=function(){throw new Error("方法没有实现")};class y extends class{defaultOptions;cache;proxyMethod={clear:!1,delete:!1,get:!1,head:!1,options:!1,patch:!1,post:!1,put:!1,request:!1};constructor(e){this.defaultOptions=Object.assign(n(e),{adapter:e.adapter?Array.isArray(e.adapter)?e.adapter:[e.adapter]:[]}),this.cache=new t(this.defaultOptions.storage,this.defaultOptions.message,this.defaultOptions.prefix),this.defaultOptions.proxy.forEach((e=>this.proxyMethod[e]=!0))}request(e){if(!this.beforeStore(e)){const t=this.key(e);return e.force?this.realRequest(e).then(this.getOnfulfilled(t,e)):this.proxyRequest(e,t)}return this.realRequest(e)}clear(e){this.cache.clear(this.key(e))}getOnfulfilled(e,t){return r=>function(e,t,r,s,i){return r.valid&&r.valid(e)||s.valid(e)?i.set(t,e):i.clear(t),e}(r,e,t,this.defaultOptions,this.cache)}realRequest(e){if(Array.isArray(this.defaultOptions.adapter))for(let t=0;t<this.defaultOptions.adapter.length;++t){const r=this.defaultOptions.adapter[t](e);if(null!=r)return g(r)?r:Promise.resolve(r)}return Promise.reject("adapter not implements!!!")}proxyRequest(e,t){let r;return(r=this.cache.get(t,e.expire??this.defaultOptions.maxAge))?g(r)?r:Promise.resolve(r):this.realRequest(e).then(this.getOnfulfilled(t,e))}beforeStore(e){return!this.proxyMethod[e.method]||!1===e.hit||!e.hit&&!o(this.defaultOptions.enableCache,e.url,e.method)}key(e){return e?this.defaultOptions.generateKey(this.defaultOptions.key,e.url,e.method,e.headers,e.params,e.data):null}}{constructor(e={}){super(e)}static create(e={}){return new y(e)}clear(e){super.clear(e)}request(e){return e.method=e.method??"get",super.request(e)}getUri(e){return this.request(e)}get(e,t={}){return this.request(this.beforeConfig(t,e))}delete(e,t={}){return this.request(this.beforeConfig(t,e,"delete"))}head(e,t={}){return this.request(this.beforeConfig(t,e,"head"))}options(e,t={}){return this.request(this.beforeConfig(t,e,"options"))}post(e,t,r={}){return this.request(this.beforeConfig(r,e,"post",t))}put(e,t,r={}){return this.request(this.beforeConfig(r,e,"put",t))}patch(e,t,r={}){return this.request(this.beforeConfig(r,e,"patch",t))}postForm(e,t,r={}){return this.request(this.beforeConfig(r,e,"postForm",t))}putForm(e,t,r={}){return this.request(this.beforeConfig(r,e,"putForm",t))}patchForm(e,t,r={}){return this.request(this.beforeConfig(r,e,"patchForm",t))}beforeConfig(e,t,r,s){return e.url=t??e.url,e.method=r??e.method,e.data=s??e.data,e}}export{y as default,f as http,d as proxy};
