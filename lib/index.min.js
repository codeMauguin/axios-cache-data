import e from"axios";class t{serializationKey(e){return e}}class i{deserializationKey(e){return e}}class s extends t{serialization(e){return JSON.stringify(e)}}class a extends i{deserialization(e){return JSON.parse(e)}}class r{storage;prefix;message;constructor(e,t,i){this.storage=e,this.message=t,this.prefix=i}}class n extends r{constructor(e,t,i){super(e,t,i)}static isExpired(e,t){return(new Date).getTime()>=t+e}get(e,t){const i=this.message.serialization.serializationKey(`${this.prefix}:${e}`),s=this.storage.getItem(i);if(null==s)return null;const a=this.message.deserialization.deserialization(s);return n.isExpired(a.expire,t)?(this.storage.removeItem(i),null):a.value}set(e,t){this.storage.setItem(this.message.serialization.serializationKey(`${this.prefix}:${e}`),this.message.serialization.serialization({value:t,expire:(new Date).getTime()}))}clear(e){if(e)this.storage.removeItem(this.message.serialization.serializationKey(`${this.prefix}:${e}`));else for(let e=0;e<this.storage.length;++e){const t=this.storage.key(e);if(null===t)continue;this.message.deserialization.deserializationKey(t).startsWith(this.prefix)&&this.storage.removeItem(t)}}}function o(e,t,i,s="HTTP_NULL_PARAM",a="HTTP_NULL_DATA"){return btoa(encodeURIComponent(`${e}&${t}${i}&${JSON.stringify(s)}-${JSON.stringify(a)}`))}function l(e,t,i){return s=>((!0===e.hit||!1!==e.hit&&t.enableCache)&&(e.valid&&e.valid(s)||t.valid(s))&&t.cache.set(i,s),s)}function c(e={}){const{maxAge:t=36e5,key:i="HTTP_CACHE_CACHE",storage:r=window.sessionStorage,prefix:l="AXIOS-CACHE",enableCache:c=!1,generateKey:g=o,valid:h=(()=>!0),message:u={deserialization:new a,serialization:new s}}=e;return{maxAge:t,key:i,storage:r,enableCache:c,generateKey:g,valid:h,message:u,cache:new n(r,u,l)}}function g(t,i){return s=>(s.adapter=t,s.force?function(t,i){const s=i.cache,a=i.generateKey(i.key,t.url,t.method,t.params,t.data);return s.clear(a),e.request(t).then(l(t,i,a))}(s,i):!0===s.hit||!1!==s.hit&&i.enableCache?function(t,i){const s=i.generateKey(i.key,t.url,t.method,t.params,t.data),a=i.cache.get(s,t.expire??i.maxAge);return null===a?e.request(t).then(l(t,i,s)):("production"!==process.env.NODE_ENV&&console.info(`${s}命中缓存`),Promise.resolve(a))}(s,i):e.request(s))}function h(t){const i=c(t),s=e.create(Object.assign(t,{adapter:g(e.defaults.adapter,i)}));return new Proxy(s,{get:(e,t,s)=>"clear"===t?()=>i.cache.clear():Reflect.get(e,t,s)})}e.withCache=h;const u=e;export{i as Deserialization,n as HttpCache,r as HttpCacheLike,t as Serialization,g as cacheAdapter,h as createHttpCacheInstance,c as createOptions,u as http};
