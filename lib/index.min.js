import e from"axios";function t(e){return Object.is(e,void 0)||Object.is(e,null)}class r extends class{storage;prefix;message;constructor(e,t,r){this.storage=e,this.message=t,this.prefix=r}}{constructor(e,t,r){super(e,t,r)}static isExpired(e,t){return(new Date).getTime()>=t+e}get(e,t){const s=this.message.serialization.serializationKey(`${this.prefix}:${e}`),i=this.storage.getItem(s);if(null==i)return null;const a=this.message.deserialization.deserialization(i);return r.isExpired(a.expire,t)?(this.storage.removeItem(s),null):a.value??null}set(e,t){this.storage.setItem(this.message.serialization.serializationKey(`${this.prefix}:${e}`),this.message.serialization.serialization({value:t,expire:(new Date).getTime()}))}clear(e,r){const s=t(e),i=t(r);if(s&&i)for(let e=0;e<this.storage.length;++e){const t=this.storage.key(e);if(null===t)continue;this.message.deserialization.deserializationKey(t).startsWith(this.prefix)&&this.storage.removeItem(t)}else if(i)for(let t=0;t<this.storage.length;++t){const r=this.storage.key(t);if(null===r)continue;this.message.deserialization.deserializationKey(r).startsWith(`${this.prefix}:${e}`)&&this.storage.removeItem(r)}else if(i||s)console.log("error clear group");else for(let t=0;t<this.storage.length;++t){const s=this.storage.key(t);if(null===s)continue;this.message.deserialization.deserializationKey(s).startsWith(`${this.prefix}:${e}&${r}`)&&this.storage.removeItem(s)}}}class s extends class{serializationKey(e){return e}}{serialization(e){return JSON.stringify(e)}}class i extends class{deserializationKey(e){return e}}{deserialization(e){return JSON.parse(e)}}const a=["get","post"];function n(e,t,r,s,i,a,n){return btoa(encodeURIComponent(`${e}&${t}&${r}${s}&${JSON.stringify(i)}&${JSON.stringify(a)}-${JSON.stringify(n)}`))}function o(e){const{maxAge:t=36e5,key:r="HTTP_CACHE_CACHE",storage:o=window.sessionStorage,prefix:l="AXIOS-CACHE",enableCache:u=!1,generateKey:c=n,valid:h=(()=>!0),message:f={deserialization:new i,serialization:new s},proxy:p=a}=e;return{maxAge:t,key:r,storage:o,enableCache:u,generateKey:c,valid:h,message:f,proxy:p,prefix:l}}function l(e,t){return Object.is(e,null)||Object.is(e,void 0)?t.default:Reflect.apply(e,this,t.args)}function u(e,...t){if(Object.is(e,null)||Object.is(e,void 0))return null;if("function"==typeof e)try{return Reflect.apply(e,this,t)}catch(e){return null}return e}function c(e,t,r,s){return l(r.valid,{default:!0,args:[e]})&&l(s.valid,{default:!0,args:[e]})&&s.cache.set(t,e),e}function h(e,t,r,s,i,a,n,o){const{hit:l,force:h}=s;if(!1===l||!u(e.enableCache,t,r)&&!0!==l)return Reflect.apply(i,a,n);if(!0===h)return Promise.resolve(Reflect.apply(i,a,n)).then((t=>c(t,o,s,e)));const f=e.cache.get(o,s.expire??e.maxAge);return null===f?Promise.resolve(Reflect.apply(i,a,n)).then((t=>c(t,o,s,e))):Promise.resolve(f)}const f=function(e,t){return{apply(r,s,i){const a={hit:i[2]?.hit,force:i[2]?.force,expire:i[2]?.expire,valid:i[2]?.valid},n=i[0],o=t.generateKey(t.key,i[2]?.group??"DEFAULT_GROUP",i[0],e,i[2]?.header??null,i[2]?.params??null,i[1]??null);return h(t,n,e,a,r,s,i,o)}}},p=function(e,t){return{apply(r,s,i){const a={hit:i[1]?.hit,force:i[1]?.force,expire:i[1]?.expire,valid:i[1]?.valid},n=i[0],o=t.generateKey(t.key,i[1]?.group??"DEFAULT_GROUP",i[0],e,i[1]?.header,i[1]?.params??null,i[1]?.data??null);return h(t,n,e,a,r,s,i,o)}}},g=function(e,t){return{apply(r,s,i){const a={hit:i[0]?.hit,force:i[0]?.force,expire:i[0]?.expire,valid:i[0]?.valid},n=i[0].url,o=i[1].method??"get",l=t.generateKey(t.key,i[0]?.group??"DEFAULT_GROUP",i[0]?.url,e,i[0]?.header,i[0]?.params??null,i[0]?.data??null);return h(t,n,o,a,r,s,i,l)}}};function d(t,r={}){return y(e.create(t),r)}function y(e,t={}){let s=Object.assign(o(t));s=Object.assign(s,{cache:new r(s.storage,s.message,s.prefix)});const i=function(e,t,r){const s={};for(let i=0;i<t.length;++i){const a=Reflect.get(e,t[i],e);if(!a)continue;const n=t[i];switch(n){case"delete":case"head":case"options":case"get":s[n]=new Proxy(a,p(n,r));break;case"request":s[n]=new Proxy(a,g(n,r));break;case"post":case"put":case"patch":s[n]=new Proxy(a,f(n,r))}}return s}(e,s.proxy,s);i.clear=()=>s.cache.clear();const a={};return s.proxy.forEach((e=>a[e]=!0)),new Proxy(e,{get:(e,t,r)=>i[t]?i[t]:Reflect.get(e,t,r),apply(e,t,r){if(!r||0===r.length)return Reflect.apply(e,t,r);const i="string"==typeof r[0],n=(i?r[1]?.method:r[0]?.method)??"get";if(a[n]){const a=i?p(n,s):g(n,s);return a.apply&&a.apply(e,t,r)}return Reflect.apply(e,t,r)}})}function m(e){return"object"==typeof e&&"function"==typeof e.then&&"function"==typeof e.catch}d.proxy=y,e.withCache=d,e.clear=function(){throw new Error("方法没有实现")};class x extends class{defaultOptions;cache;proxyMethod={clear:!1,delete:!1,get:!1,head:!1,options:!1,patch:!1,post:!1,put:!1,request:!1};constructor(e){this.defaultOptions=Object.assign(o(e),{adapter:e.adapter?Array.isArray(e.adapter)?e.adapter:[e.adapter]:[]}),this.cache=new r(this.defaultOptions.storage,this.defaultOptions.message,this.defaultOptions.prefix),this.defaultOptions.proxy.forEach((e=>this.proxyMethod[e]=!0))}request(e){if(!this.beforeStore(e)){const t=this.key(e);return e.force?this.realRequest(e).then(this.getOnfulfilled(t,e)):this.proxyRequest(e,t)}return this.realRequest(e)}clear(e){this.cache.clear(this.key(e))}getOnfulfilled(e,t){return r=>function(e,t,r,s,i){return r.valid&&r.valid(e)||s.valid(e)?i.set(t,e):i.clear(t),e}(r,e,t,this.defaultOptions,this.cache)}realRequest(e){if(Array.isArray(this.defaultOptions.adapter))for(let t=0;t<this.defaultOptions.adapter.length;++t){const r=this.defaultOptions.adapter[t](e);if(null!=r)return m(r)?r:Promise.resolve(r)}return Promise.reject("adapter not implements!!!")}proxyRequest(e,t){let r;return(r=this.cache.get(t,e.expire??this.defaultOptions.maxAge))?m(r)?r:Promise.resolve(r):this.realRequest(e).then(this.getOnfulfilled(t,e))}beforeStore(e){return!this.proxyMethod[e.method]||!1===e.hit||!e.hit&&!u(this.defaultOptions.enableCache,e.url,e.method)}key(e){return e?this.defaultOptions.generateKey(this.defaultOptions.key,e?.group??"DEFAULT_GROUP",e.url,e.method,e.headers,e.params,e.data):null}}{constructor(e={}){super(e)}static create(e={}){return new x(e)}request(e){return e.method=e.method??"get",super.request(e)}clear(e){super.clear(e)}getUri(e){return this.request(e)}get(e,t={}){return this.request(this.beforeConfig(t,e))}delete(e,t={}){return this.request(this.beforeConfig(t,e,"delete"))}head(e,t={}){return this.request(this.beforeConfig(t,e,"head"))}options(e,t={}){return this.request(this.beforeConfig(t,e,"options"))}post(e,t,r={}){return this.request(this.beforeConfig(r,e,"post",t))}put(e,t,r={}){return this.request(this.beforeConfig(r,e,"put",t))}patch(e,t,r={}){return this.request(this.beforeConfig(r,e,"patch",t))}postForm(e,t,r={}){return this.request(this.beforeConfig(r,e,"postForm",t))}putForm(e,t,r={}){return this.request(this.beforeConfig(r,e,"putForm",t))}patchForm(e,t,r={}){return this.request(this.beforeConfig(r,e,"patchForm",t))}beforeConfig(e,t,r,s){return e.url=t??e.url,e.method=r??e.method,e.data=s??e.data,e}}export{x as default,d as http,y as proxy};
