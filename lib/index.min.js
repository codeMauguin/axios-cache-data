import e from"axios";class t extends class{storage;prefix;message;constructor(e,t,r){this.storage=e,this.message=t,this.prefix=r}}{constructor(e,t,r){super(e,t,r)}static isExpired(e,t){return(new Date).getTime()>=t+e}get(e,r){const i=this.message.serialization.serializationKey(`${this.prefix}:${e}`),n=this.storage.getItem(i);if(null==n)return null;const s=this.message.deserialization.deserialization(n);return t.isExpired(s.expire,r)?(this.storage.removeItem(i),null):s.value??null}set(e,t){this.storage.setItem(this.message.serialization.serializationKey(`${this.prefix}:${e}`),this.message.serialization.serialization({value:t,expire:(new Date).getTime()}))}clear(e){if(e)this.storage.removeItem(this.message.serialization.serializationKey(`${this.prefix}:${e}`));else for(let e=0;e<this.storage.length;++e){const t=this.storage.key(e);if(null===t)continue;this.message.deserialization.deserializationKey(t).startsWith(this.prefix)&&this.storage.removeItem(t)}}}class r extends class{serializationKey(e){return e}}{serialization(e){return JSON.stringify(e)}}class i extends class{deserializationKey(e){return e}}{deserialization(e){return JSON.parse(e)}}const n=["get","post"];function s(e,t,r,i,n,s){return btoa(encodeURIComponent(`${e}&${t}${r}&${JSON.stringify(i)}&${JSON.stringify(n)}-${JSON.stringify(s)}`))}function a(e,t,r,i){return(r.valid&&r.valid(e)||i.valid(e))&&i.cache.set(t,e),e}function o(e,t,r,i,n,s,o,l){const{hit:c,force:u}=i;if(!1===c||!function(e,...t){if(null==e)return null;if("function"==typeof e)try{return Reflect.apply(e,this,t)}catch(e){return null}return e}(e.enableCache,t,r)&&!0!==c)return Reflect.apply(n,s,o);if(!0===u)return Promise.resolve(Reflect.apply(n,s,o)).then((t=>a(t,l,i,e)));const p=function(e,t,r,i){return i.get(e,t.expire??r.maxAge)}(l,i,e,e.cache);return null===p?Promise.resolve(Reflect.apply(n,s,o)).then((t=>a(t,l,i,e))):("production"!==process.env.NODE_ENV&&console.info(`${l}命中缓存`),Promise.resolve(p))}const l=function(e,t){return{apply(r,i,n){const s={hit:n[2]?.hit,force:n[2]?.force,expire:n[2]?.expire,valid:n[2]?.valid},a=n[0],l=t.generateKey(t.key,n[0],e,n[2]?.header??null,n[2]?.params??null,n[1]??null);return o(t,a,e,s,r,i,n,l)}}},c=function(e,t){return{apply(r,i,n){const s={hit:n[1]?.hit,force:n[1]?.force,expire:n[1]?.expire,valid:n[1]?.valid},a=n[0],l=t.generateKey(t.key,n[0],e,n[1]?.header,n[1]?.params??null,n[1]?.data??null);return o(t,a,e,s,r,i,n,l)}}},u=function(e,t){return{apply(r,i,n){const s={hit:n[0]?.hit,force:n[0]?.force,expire:n[0]?.expire,valid:n[0]?.valid},a=n[0].url,l=n[1].method??"get",c=t.generateKey(t.key,n[0]?.url,e,n[0]?.header,n[0]?.params??null,n[0]?.data??null);return o(t,a,l,s,r,i,n,c)}}};function p(t,r={}){return f(e.create(t),r)}function f(e,a={}){const o=function(e){const{maxAge:a=36e5,key:o="HTTP_CACHE_CACHE",storage:l=window.sessionStorage,prefix:c="AXIOS-CACHE",enableCache:u=!1,generateKey:p=s,valid:f=(()=>!0),message:h={deserialization:new i,serialization:new r},proxy:g=n}=e;return{maxAge:a,key:o,storage:l,enableCache:u,generateKey:p,valid:f,message:h,cache:new t(l,h,c),proxy:g}}(a),p=function(e,t,r){const i={};for(let n=0;n<t.length;++n){const s=Reflect.get(e,t[n],e);if(!s)continue;const a=t[n];switch(a){case"delete":case"head":case"options":case"get":i[a]=new Proxy(s,c(a,r));break;case"request":i[a]=new Proxy(s,u(a,r));break;case"post":case"put":case"patch":i[a]=new Proxy(s,l(a,r))}}return i}(e,o.proxy,o);p.clear=()=>o.cache.clear();const f={};return o.proxy.forEach((e=>f[e]=!0)),new Proxy(e,{get:(e,t,r)=>p[t]?p[t]:Reflect.get(e,t,r),apply(e,t,r){if(!r||0===r.length)return Reflect.apply(e,t,r);const i="string"==typeof r[0],n=(i?r[1]?.method:r[0]?.method)??"get";if(f[n]){const s=i?c(n,o):u(n,o);return s.apply&&s.apply(e,t,r)}return Reflect.apply(e,t,r)}})}p.proxy=f,e.withCache=p,e.clear=function(){throw new Error("方法没有实现")};export{p as http,f as proxy};
